{% extends 'layouts/base.html' %}

{% block content %}


<script>
    function initMap() {
        
        const directionsService = new google.maps.DirectionsService();
        const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: { lat: 53.349804, lng: -6.260310 },
                disableDefaultUI: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
        });
        

        const control =  document.getElementById("sidebar");
        map.controls[google.maps.ControlPosition.TOP_RIGHT].push(control);
        //const control =  document.getElementById("floating-panel");
        //map.controls[google.maps.ControlPosition.TOP_CENTER].push(control);

        //const stepDisplay = new google.maps.InfoWindow();
        //const directionsRenderer = new google.maps.DirectionsRenderer();
        //directionsRenderer.setMap(map); 
        //directionsRenderer.setPanel(document.getElementById("sidebar"));
        //const search_result=document.getElementById("sidebar");
        //map.controls[google.maps.ControlPosition.TOP_LEFT].push(search_result);
        //let route_history = [];
        //document.getElementById("search_route").addEventListener("click", () => {
            //calculateAndDisplayRoute(directionsService,directionsRenderer, map,route_history);
        //});

        var i=0;
        const markerArray = [];
        const stopArray=[];
        const requestArray=[];
        "{% for stop in route_Info %}"
            var stop_position={
                lat:Number("{{stop.stop.lat}}"),
                lng:Number("{{stop.stop.lng}}"),
            };

            stopArray[i]="{{stop.stop.lat}}".toString()+","+"{{stop.stop.lng}}".toString();

            markerArray[i] = new google.maps.Marker({
                position: stop_position,
                map: map,
                title:"{{stop.stop.stop_name}}",
                label:"{{stop.stop_sequence}}",
            });

/* 
            markerArray[i].addListener("click", () => {
                stepDisplay.setContent(
                    '<p style="color:black">'+"{{stop.stop.stop_name}}"+'</p>'
                );
                stepDisplay.open(map, markerArray[i]);
            });

            
            
            if (i>0){
                requestArray[i-1]={
                    origin: stopArray[i-1],
                    destination: stopArray[i],
                    travelMode: google.maps.TravelMode.TRANSIT,
                    transitOptions: {modes: ["BUS"],routingPreference:["FEWER_TRANSFERS"]}, 
                };
            }



                setTimeout(
                    directionsService.route(request, function(response, status) {
                        var flightPath = new google.maps.Polyline({
                            path: response.routes[0].overview_path,
                            strokeColor: "#000000",
                            strokeOpacity: 0.8,
                            strokeWeight: 3.5,
                            map: map
                        });
                    })    
                    //calculateAndDisplayRoute((directionsService,map,start_stop,end_stop,delayFactor));
                , 2000);
                
                directionsService.route(request, function(response, status) {



                    if (status === google.maps.DirectionsStatus.OK) {
                        var flightPath = new google.maps.Polyline({
                            path: response.routes[0].overview_path,
                            strokeColor: "#000000",
                            strokeOpacity: 0.8,
                            strokeWeight: 3.5,
                            map: map
                        });
                    }else if (status === google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
                        //delayFactor++;
                        
                        setTimeout(function () {
                            var flightPath = new google.maps.Polyline({
                                path: response.routes[0].overview_path,
                                strokeColor: "#000000",
                                strokeOpacity: 0.8,
                                strokeWeight: 3.5,
                                map: map
                            });
                            //calculateAndDisplayRoute((directionsService,map,start_stop,end_stop,delayFactor));
                        }, 2000);
                        //delayFactor * 1000);
                        //console.log(delayFactor);
                    
                    }



                });


                //calculateAndDisplayRoute(directionsService,map,stopArray[i-1],stopArray[i],delayFactor);
*/
            i++;
        "{% endfor %}" 
        const latlngStr = stopArray[0].split(",", 2);
        const latlng = {
            lat: parseFloat(latlngStr[0]),
            lng: parseFloat(latlngStr[1]),
        };
        map.setCenter(latlng);
    };

/*
        
        var delayFactor=100;
        var nextPolyline=0;
        function getPolyline(request, next) {
            console.log(nextPolyline);
            directionsService.route(request, function(response, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    var flightPath = new google.maps.Polyline({
                        path: response.routes[0].overview_path,
                        strokeColor: "#000000",
                        strokeOpacity: 0.8,
                        strokeWeight: 3.5,
                        map: map
                    });
                }else if (status === google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
                    nextPolyline--;
                    delayFactor++;
                }else {
                    var reason="Code "+status;
                    console.log(reason);
                };
                next();
            }); 
        };
        function theNext() {
            if (nextPolyline < requestArray.length) {
                setTimeout(function () {
                    getPolyline(requestArray[nextPolyline-1],theNext);
                },delayFactor);
            };
            nextPolyline++;
        };
        theNext();

*/
        
    
/*
    function calculateAndDisplayRoute(directionsService,map,start_stop,end_stop,delayFactor) {
        //for (let i = 0; i < markerArray.length; i++) {
            //markerArray[i].setMap(null);
        //};
        //const route=document.getElementById("route").value;
        //if(!route) return;
        //const start = document.querySelector("#routes"  + " option[value='" + route+ "']").dataset.value;
        //const end = document.querySelector("#routes"  + " option[value='" + route+ "']").dataset.id;
        var request={
            origin: start_stop,
            destination: end_stop,
            travelMode: google.maps.TravelMode.TRANSIT,
            transitOptions: {modes: ["BUS"],routingPreference:["FEWER_TRANSFERS"]}, 
        };
        directionsService.route(request, function(response, status) {
            if (status === google.maps.DirectionsStatus.OK) {
                var flightPath = new google.maps.Polyline({
                    path: response.routes[0].overview_path,
                    strokeColor: "#000000",
                    strokeOpacity: 0.8,
                    strokeWeight: 3.5,
                    map: map
                });
            }else if (status === google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
                delayFactor++;
                setTimeout(function () {
                    calculateAndDisplayRoute((directionsService,map,start_stop,end_stop,delayFactor));
                }, delayFactor * 10000);
                console.log(delayFactor);
            }
        });
    }

        directionsService.route().then((response,status) => {
            //for (let i = 0; i < route_history.length; i++) {
                //route_history[i].setMap(null);
            //};
            console.log("Working");
            if (status === 'OK') {
                var flightPath = new google.maps.Polyline({
                    path: response.routes[0].overview_path,
                    //levels: decodedLevels,
                    strokeColor: "#000000",
                    strokeOpacity: 0.8,
                    strokeWeight: 3.5,
                    map: map
                });
            }
            else if (status == google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {
                wait = true;
                setTimeout("wait = true", 2000);
                //alert("OQL: " + status);
            }
       
            
            //route_history.push(response.routes[0].overview_path);    
            //directionsRenderer.setDirections(response);
            //document.getElementById("sidebar").innerHTML ="" + response.routes[0].overview_polyline;  
            //+ "</b> <hr/> Path:"+response.routes[0].overview_path;
            //directionsRenderer.setDirections(response);
            //showSteps(response, markerArray, stepDisplay, map);
        });
    }
    

    function showSteps(directionResult, markerArray, stepDisplay, map) {
        const myRoute = directionResult.routes[0].legs[0];
        for (let i = 0; i < myRoute.steps.length; i++) {
            const marker = (markerArray[i] =
            markerArray[i] || new google.maps.Marker());
            marker.setMap(map);
            marker.setPosition(myRoute.steps[i].start_location);
            attachInstructionText(
            stepDisplay,
            marker,
            myRoute.steps[i].instructions,
            map
            );
        }
    }


    function attachInstructionText(stepDisplay, marker, text, map) {
        google.maps.event.addListener(marker, "click", () => {
            stepDisplay.setContent(text);
            stepDisplay.open(map, marker);
        });
    };  
*/    
</script>


<div class="container-fluid" >
    
    <div  id="map" style="width:100%;height:700px; padding-left:0;padding-right:0;">map</div> 
    <div id="sidebar" style="overflow:auto;height:300px;padding-left:0;padding-right:0;">
        {% if route_Info %}
            <div id="SelectedRoute" style="display:none" >
                <form action="" style="text-align:center; vertical-align:bottom;margin-block-end:0;width:100%;">
                    {% csrf_token %}
                    <input type="text" name="search"  placeholder="Search Bus Route Here" class="route_input" style="width:100%">
                </form>
                
            </div>
            <div id="SelectedStops" style="width:200px;">
                <button class="btn-primary" style="width:30%;height:30px" onclick="backToRoutes()">Back</button>
                <hr>
                {% for stop in route_Info %}
                    <p style="color: #fff;">
                        {{stop.stop_sequence}}: &nbsp {{stop.stop.stop_name}},  &nbsp    {{stop.route_number}}
                    </p>
                    <hr>
                {% endfor %}
            </div>
        {%else%}
            <div id="SelectedRoute">
                <form action="" style="text-align:center; vertical-align:bottom;margin-block-end:0;width:100%; position:sticky">
                    {% csrf_token %}
                    <input type="text" name="search" placeholder="Search Bus Route Here" class="route_input" style="width:100%">
                </form>
        
            </div> 
            <div id="SelectedStops" style="display:none"></div>
        {% endif%}
    </div>
</div>

<script>
    var route_value_list = [];
    var route_info_list = [];
    var user_input = document.getElementsByClassName("route_input")[0];
    var SelectedRoute = document.getElementById("SelectedRoute");
    var routeButtons = document.createElement("div");
    routeButtons.id = "buttons";
    routeButtons.className="btn-group-vertical";
    SelectedRoute.appendChild(routeButtons);
    "{% for route_name in routes_name %}"
        route_value_list.push("{{ route_name.route_name }}".toString()+","+"{{ route_name.route_direction }}".toString());
        var route_info="{{ route_name.route_name }}"+": "+"{{route_name.route_description}}";
        route_info=route_info.replace(/&#x27;/g,"'");
        route_info_list.push(route_info);
    "{% endfor %}" 
    function createRouteButtons(route_info,route_value){
        //var route_hr = document.createElement("HR");
        var route_form = document.createElement("form");
        route_form.action="";
        route_form.method="post";
        route_form.className="route_form";
        
        
        var csrf = document.createElement('input');
        var csrfToken = document.getElementsByName('csrfmiddlewaretoken')[0].value
        csrf.setAttribute("type","hidden");
        csrf.setAttribute("name","csrfmiddlewaretoken");
        csrf.setAttribute("value",csrfToken);
        route_form.appendChild(csrf);

        var route_button = document.createElement("BUTTON");
        var route_name = document.createTextNode(route_info);
        route_button.appendChild(route_name);
        route_button.name = "route_name";
        route_button.value = route_value;
        route_button.className="btn btn-primary route-btn";
        
        route_form.appendChild(route_button);
        
        document.getElementById("buttons").appendChild(route_form);
        //document.getElementById("buttons").appendChild(route_hr);   
    }
    function displayAll(){
        for(var i=0;i<route_info_list.length;i++){
            createRouteButtons(route_info_list[i],route_value_list[i]);
        }
    };
    
    user_input.onfocus = function(){
        document.getElementById("buttons").style.display="block"; 
        if (user_input.value==""){
            displayAll();
        };   
    };
    //user_input.onblur = function(){
        //document.getElementById("buttons").style.display="none";
    //};
    user_input.oninput = function() {
        var buttons_before = document.getElementById("buttons");
        SelectedRoute.removeChild(buttons_before);
        var routeButtons = document.createElement("div");
        routeButtons.id = "buttons";
        SelectedRoute.appendChild(routeButtons);
        if (user_input.value==""){
            displayAll();
        }else{
            for(var i=0;i<route_info_list.length;i++){
                if(route_info_list[i].indexOf(user_input.value)>=0){
                    createRouteButtons(route_info_list[i],route_value_list[i]);
                }
            };
        } 
    }

    function backToRoutes(){
        document.getElementById('SelectedRoute').style.display ="block";
        document.getElementById('SelectedStops').style.display ="none";
        displayAll();
    }
        
</script>
<script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbl2iDuIG5vhOpzFUYHxFRZNg8RwDnW2M&callback=initMap&libraries=&v=weekly"
    async
></script>

{% endblock %}
